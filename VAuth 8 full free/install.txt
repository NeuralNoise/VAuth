########################################################################
######################*   DLE module   *################################
######################*   VAuth v.1.8  *################################
######################*   by lifeart   *################################
######################* vk.com/lifeart *################################
######################*  vk.com/vauth  *################################
########################################################################

Демосайт: vauth8.dream-notes.ru

Возможности модуля:

- Авторизация и регистрация пользователей на сайте через социальные сети:
		
		vkontakte, facebook, twitter, одноклассники, мир@mail.ru, google+, foursquare, instagram, windows live (MSDN), github
		
- Автоматическая установка аватарки пользователя при регистрации.
- Установка аватарки DLE пользователя при сопряжении аккаунта с любой соц.сетью.
- Заполнение данных пользователя на основании информации, полученной из социальных сетей.
- Вывод зарегистрированных друзей пользователя на сайте (друзей по социальным сетям, которые есть на этом-же сайте).
- Возможность задавать отдельную группу пользователя для каждой социальной сети.
- Сохранение возможности регистрации пользователей обычным способом
- Заполнение поля профиля DLE "О себе" (страна проживания, мобильный телефон, статус вконтакте, пол).
- Возможность смены e-mail пользователя без ошибок авторизации.
- Возможность смены пароля пользователя без ошибок авторизации.
- Возможность задавать размер аватарки пользователя, центрировать и обрезать её.
- Переадресация пользователя после авторизации на ранее просматриваемую страницу.
- Весь текст вынесен в отдельный файл, для удобства перевода.
- Статистика по пользователям в админ-панели.
- Вывод всех зарегистрированных через vauth пользователей в админ-панели.
- Возможность вывода формы ввода желаемого email/login/password при регистрации пользователя.
- Отправка ПС пользователю после регистрации с данными авторизации.

		Новое в версии 1.8:

1.	- Исправлены небольшие ошибки и недочёты.
2.	- Увеличена безопасность авторизации.
3.	- Увеличена скорость работы модуля.
4.	- Добавлена возможность авторизации через 7 новых социальных сетей:
	
		+ Одноклассники
		+ Мир@mail.ru
		+ Google+
		+ Foursquare
		+ Instagram
		+ Windows Live (MSDN)
		+ GitHub

		+ vkontakte	( реализовано ранее )
		+ facebook	( реализовано ранее )
		+ twitter 	( реализовано ранее )

5.	- Изменён дизайн кнопки логина, логин-панель выводится при помощи FaceBox.
6.	- Стили оформления вынесены в отдельные файлы.
8.	- Добавлена возможность авторизации пользователя при совпадении e-mail'a из социальной сети с e-mail'ом в БД движка.
9.	- Усовершенствована форма ввода логина при регистрации, теперь пользователь может проверить доступность имени для регистрации.

		Изменения в админке:

10.	- Изменён дизайн меню модуля, адаптирован под стандартную тему DLE.
11.	- Добавлена возможность отображения списка пользователей списком и аватарками.
12.	- Добавлена возможность удаления пользователя прямо из админки модуля.
13.	- Добавлен поиск пользователя по:

		полу, социальной сети, времени регистрации, дате регистрации, последнему посещению, бану,
		email, логину, группе, количеству публикаций, количеству комментариев, наличию друзей

14.	- Добавлена сортировка результатов выдачи: новые внизу/новые вверху.
15.	- Добавлен постраничный вывод результатов поиска.
16.	- Добавлены новые пункты статистики пользователей.
17.	- Статистика пользователей кликабельна (при нажатии выводится список пользователей, удавлетворяющих требованиям статистики)


Соглашение между автором модуля и пользователем:

	"
		Модуль - набор PHP файлов, предоставляемых Клиенту.
		Автор Модуля - Александр Канунников, далее "Автор".

		Автор не несёт ответственность за возможные проблемы, возникшие во время установки или эксплуатации Модуля.
		Автор не несёт ответственность за социальные сети, в которых Вы регистрируете приложения:
	
				т.е. если в регистрации приложения вам будет отказано,
				то вы не в праве требовать возмещения ущерба от автора,
				если социальная сеть отказывается авторизировать пользователя,
				то Автор не несёт за это ответственности.
				
	"


	
Установка VAuth:

0.	Если ваш текстовый редактор не показывает номера строк, рекомендую воспользоваться редактором Notepad++ 
	
		Всегда последняя версия тут: http://filehippo.com/download_notepad/


# Регистрируем приложения (инструкция в файле "регистрация приложений.txt")



1.	Запустите из корня сайта файл install_vauth_8.php
		( находится в присланной папке vauth_8, сначала скиньте его в корень сайта )
		для win1251 версии движка вам нужен install_vauth_8_1251.php

2.	После установки полей, удалите install_vauth_8.php с сайта
	
3.	Заменяем /engine/api/api.class.php файлом, распространяющимся с модулем в папке  /engine/api/api.class.php
	
4.	- Открыть /engine/modules/profile.php

		найти
			$tpl->load_template( 'userinfo.tpl' );
			while ( $row = $db->get_row( $sql_result ) ) {
	
			$user_found = TRUE;
		
		ниже вставить:

			include_once('vauth/userinfo.php');
		
		#В 278 строке:

		Вместро строк:
			
			$password1 = md5( md5( $password1 ) );
			$sql_user = "UPDATE " . USERPREFIX . "_users set fullname='$fullname', land='$land', icq='$icq',{$mailchange} info='$info', signature='$signature', password='$password1', allow_mail='$allow_mail', xfields='$filecontents', allowed_ip='$allowed_ip' WHERE user_id = '{$id}'";


		Вставляем строки:

			include_once (ENGINE_DIR . '/modules/vauth/passhash.php');
			$pass_hash = get_passhash(@md5($password1));		
			$password1 = md5( md5( $password1 ) );
			$sql_user = "UPDATE " . USERPREFIX . "_users set userpassword_hash='$pass_hash', fullname='$fullname', land='$land', icq='$icq',{$mailchange} info='$info', signature='$signature', password='$password1', allow_mail='$allow_mail', xfields='$filecontents', allowed_ip='$allowed_ip' WHERE user_id = '{$id}'";
		
		Cохраняемся.

5.	-Открыть /engine/engine.php
			в 43 строке после:
				switch ( $do ) {
			добавляем: 
		
				case "account_connect" :
					include ENGINE_DIR . '/modules/vauth/acc_connect.php';
					break;
		Сохраняемся.

6.	- Открыть /engine/modules/lostpassword.php line 58

		Вместро строки:
			
			$db->query( "UPDATE " . USERPREFIX . "_users set password='" . md5( md5( $new_pass ) ) . "', allowed_ip = '' WHERE user_id='$douser'" );
		
		Вставляем строки: 

			include_once (ENGINE_DIR . '/modules/vauth/passhash.php');
			$pass_hash = get_passhash(@md5($new_pass));
			$db->query( "UPDATE " . USERPREFIX . "_users set userpassword_hash='$pass_hash', password='" . md5( md5( $new_pass ) ) . "', allowed_ip = '' WHERE user_id='$douser'" );
		
		Сохраняемся.

7.	- Открыть /engine/inc/editusers.php line 1198

		Вместро строк:

		if( trim( $_POST['editpass'] ) != "" ) {
			$editpass = md5( md5( $_POST['editpass'] ) );
			$sql_update .= ", password='$editpass'";
		}
		
		Вставляем строки:

		if( trim( $_POST['editpass'] ) != "" ) {

			include_once (ENGINE_DIR . '/modules/vauth/passhash.php');
			$pass_hash = get_passhash(@md5($_POST['editpass']));
			$editpass = md5( md5( $_POST['editpass'] ) );
			$sql_update .= ", userpassword_hash='$pass_hash', password='$editpass'";
		}
		
		Сохраняемся.
			

8.	- Кидаем файл из присланной папки vauth_8/acc_connect.tpl в папку вашего дизайна на сайте

9.	- Кидаем папку vauth в /engine/modules/ на сервере.
	
		################### ВАЖНО! #################################################
	
		выставляем для /engine/modules/vauth/settings/user_settings.php права 666 (CHMOD 0666)
		копируем /modules/.htaccess в соотв. папку на сайте, заменить при необходимости (dle 10+)

		################### ВАЖНО! #################################################


	- Кидаем файл vauth.php из папки /engine/inc/ в /engine/inc/ на сервере.
	- Кидаем папку engine/skins/v_images в соответствующую папку на сервере (dle 10+)
	- Кидаем v_calendar-blue.css из папки /engine/skins в /engine/skins на сервере.
	- Кидаем v_calendar.js из папки /engine/skins в /engine/skins на сервере.
	- Кидаем картинку vauth.png из папки /engine/skins в /engine/skins на сервере.

10.	- Дополнительная информация о пользователе выводится через userinfo.tpl:
		
		прилагается страндартный /userinfo.tpl (дизайна Default) с уже добавленными полями
		

11.	-URL для сопряжения аккаунтов пользователя: адрес_сайта/index.php?do=account_connect
		// Ничего с этим делать не нужно.

12.	-Установите ссылки для авторизации пользователей в удобное место дизайна:
			ссылка для авторизации через контакт: адрес_сайта/engine/modules/vauth/auth.php?auth_site=vkontakte
			ссылка для авторизации через фейсбук: адрес_сайта/engine/modules/vauth/auth.php?auth_site=facebook
			ссылка для авторизации через твиттер: адрес_сайта/engine/modules/vauth/auth.php?auth_site=twitter
			
			общий вид:
				
				(**адрес_сайта**)/engine/modules/vauth/auth.php?auth_site=(**Англоязычное название сайта для авторизции**)

		или воспользуйтесь уже готовым шаблоном login.tpl для стиля Deafult, присланном вместе с модулем или
		воспользуйтесь кодом, который находится в файле "loginform_example.txt"

13.	- Заходим в админ-панель, переходим по адресу admin.php?mod=vauth&page=settings
		
		Настраиваем модуль: вставьте данные, полученные при регистрации приложений в социальных сетях
					Указываем остальные настройки. Сохраняемся.
					
					внимание! адрес сайта указывается с http:// и без www
					
					данные выглядят как "id" и "ключ" ID обычно короче чем ключ
					их нужно вставить в соответствующие поля квадратика социальной сети в настройках.
					(не оставляйте пробелов!)

14.	- Готово! Модуль установлен!

	Сделайте копию файла /engine/modules/vauth/settings/user_settings.php
	( На всякий случай, если настройки сбросятся, их можно будет восстановить)

		
15.	- Все стили оформления находятся в /vauth/styles/styles.php

16.	- Все тексты сообщений и текст интерфейса модуля находятся в /vauth/langfiles/russian.php

17.	- Если будет выскакивать ошибка PHP: "Can't send header. Header already send." откройте файл vauth/functions/vauth_functions.php и измените его кодировку на UTF-8 без BOM.

18.	- Новые теги для userinfo.tpl :
				
				{userifo-style}

				[vauth-bdate]{bdate}[/vauth-bdate] - дата рождения, если есть
				[vauth-sex]{sex}[/vauth-sex] - пол, если есть
				[vauth-mobile_phone]{mobile_phone}[/vauth-mobile_phone] - телефон, если есть
				[vauth-friends]{friends}[/vauth-friends] - друзья на сайте, если есть
				[vauth]{accounts}[/vauth] - список аккантов подключённых социальных сетей
				
				<a href="/index.php?do=account_connect">&#8594; управление</a> - ссылка на управление аккаунтами
